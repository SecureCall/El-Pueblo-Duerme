rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }
    
    function isPlayerInGame(gameId) {
        let gameDoc = get(/databases/$(database)/documents/games/$(gameId));
        return isSignedIn() && (request.auth.uid in gameDoc.data.playerUids);
    }

    match /games/{gameId} {
      // Allow read only if the user is authenticated and part of the game.
      allow read: if isPlayerInGame(gameId);
      
      // Deny all client-side writes. All mutations must go through server actions.
      allow write: if false;

      match /playerData/{userId} {
        // A user can only ever read their OWN private data.
        allow read: if request.auth.uid == userId && isPlayerInGame(gameId);
        
        // Deny all client-side writes.
        allow write: if false; 
      }
    }
  }
}

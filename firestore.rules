rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isPlayerInGame(gameId) {
        // Check if the player's UID is a key in the playerUids map on the game document.
        // This is more efficient than checking a subcollection.
        return request.auth != null && get(/databases/$(database)/documents/games/$(gameId)).data.playerUids[request.auth.uid] == true;
    }

    match /games/{gameId} {
      // Allow read only if the user is authenticated and part of the game.
      allow read: if isPlayerInGame(gameId);
      
      // Deny all client-side writes. All mutations must go through server actions.
      allow write: if false;

      // Subcollection for private player data.
      match /playerData/{userId} {
        // A user can only ever read their OWN private data.
        allow read: if request.auth.uid == userId && isPlayerInGame(gameId);
        
        // Deny all client-side writes.
        allow write: if false; 
      }
    }
  }
}

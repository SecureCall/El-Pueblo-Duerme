{
  "entities": {
    "Game": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Game",
      "type": "object",
      "description": "Represents a game instance in 'El Pueblo Duerme'.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Game entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the game."
        },
        "status": {
          "type": "string",
          "description": "Status of the game ('waiting', 'in_progress', 'finished')."
        },
        "phase": {
          "type": "string",
          "description": "Current phase of the game ('night', 'day', 'voting')."
        },
        "creator": {
          "type": "string",
          "description": "Reference to the User who created the game. (Relationship: User 1:N Game)"
        },
        "players": {
          "type": "array",
          "description": "References to Users who are playing the game. (Relationship: Game 1:N User)",
          "items": {
            "type": "string"
          }
        },
        "maxPlayers": {
          "type": "number",
          "description": "Maximum number of players allowed in the game."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the game was created.",
          "format": "date-time"
        },
        "currentRound": {
          "type": "number",
          "description": "The current round number of the game."
        },
        "settings": {
          "type": "string",
          "description": "Settings of the game."
        }
      },
      "required": [
        "id",
        "name",
        "status",
        "phase",
        "creator",
        "players",
        "maxPlayers",
        "createdAt",
        "currentRound",
        "settings"
      ]
    },
    "Player": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Player",
      "type": "object",
      "description": "Represents a player in a specific game of 'El Pueblo Duerme'.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "Reference to the User. (Relationship: User 1:N Player)"
        },
        "gameId": {
          "type": "string",
          "description": "Reference to the Game this player is in. (Relationship: Game 1:N Player)"
        },
        "role": {
          "type": "string",
          "description": "The role assigned to the player in the game ('werewolf', 'villager', 'seer', 'doctor', 'hunter')."
        },
        "isAlive": {
          "type": "boolean",
          "description": "Indicates whether the player is currently alive in the game."
        },
        "votedFor": {
          "type": "string",
          "description": "Reference to the User this player voted for. (Relationship: Player 1:N User)"
        },
        "displayName": {
          "type": "string",
          "description": "The display name of the player in the game."
        },
        "avatar": {
          "type": "string",
          "description": "The avatar of the player in the game."
        },
        "joinedAt": {
          "type": "string",
          "description": "Timestamp indicating when the player joined the game.",
          "format": "date-time"
        }
      },
      "required": [
        "userId",
        "gameId",
        "role",
        "isAlive",
        "displayName",
        "joinedAt"
      ]
    },
    "GameLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "GameLog",
      "type": "object",
      "description": "Represents a log entry for a specific game.",
      "properties": {
        "gameId": {
          "type": "string",
          "description": "Reference to the Game this log entry belongs to. (Relationship: Game 1:N GameLog)"
        },
        "type": {
          "type": "string",
          "description": "Type of log entry ('phase_change', 'kill', 'vote', 'ability_used')."
        },
        "message": {
          "type": "string",
          "description": "Descriptive message for the log entry."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp indicating when the log entry was created.",
          "format": "date-time"
        },
        "data": {
          "type": "string",
          "description": "Additional data associated with the log entry."
        }
      },
      "required": [
        "gameId",
        "type",
        "message",
        "timestamp",
        "data"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/games/{gameId}",
        "definition": {
          "entityName": "Game",
          "schema": {
            "$ref": "#/backend/entities/Game"
          },
          "description": "Stores game instances. The 'creator' field references the user who created the game. The 'players' array contains references to the users in the game.",
          "params": [
            {
              "name": "gameId",
              "description": "Unique identifier for the game."
            }
          ]
        }
      },
      {
        "path": "/players/{playerId}",
        "definition": {
          "entityName": "Player",
          "schema": {
            "$ref": "#/backend/entities/Player"
          },
          "description": "Stores player information for each game. Includes denormalized 'gameId' for authorization independence. The 'playerId' is a composite key of 'userId_gameId'.",
          "params": [
            {
              "name": "playerId",
              "description": "Unique identifier for the player in the game. Composite key in the format 'userId_gameId'."
            }
          ]
        }
      },
      {
        "path": "/game_logs/{gameLogId}",
        "definition": {
          "entityName": "GameLog",
          "schema": {
            "$ref": "#/backend/entities/GameLog"
          },
          "description": "Stores logs for each game, providing a record of game events. The 'gameId' field references the game to which the log belongs.",
          "params": [
            {
              "name": "gameLogId",
              "description": "Unique identifier for the game log entry. Consider using a timestamp-based ID for chronological ordering."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support the 'El Pueblo Duerme' game, focusing on authorization independence, clear security rules, and efficient data retrieval. Games are stored in the `/games` collection, with each game document containing essential game state and settings. Players are managed in the `/players` collection. The `gameId` is denormalized into the `/players` collection. Game logs are stored in `/game_logs`. \n\n**Authorization Independence:** The `players` collection includes the `gameId` field which allows security rules to validate whether a player belongs to a game without needing to perform a `get()` operation on the `/games/{gameId}` document. \n\n**QAPs Support:**\n*   Secure `list` operations for games are supported because authorization rules can be applied to the entire `games` collection based on user roles or game status.\n*   Secure `list` operations for players are supported by querying players based on the `gameId`, which is denormalized to avoid extra reads."
  }
}
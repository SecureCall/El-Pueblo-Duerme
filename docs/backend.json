{
  "entities": {
    "Game": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Game",
      "type": "object",
      "description": "Represents a game instance in 'El Pueblo Duerme'.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the game."
        },
        "name": {
          "type": "string",
          "description": "The name of the game."
        },
        "status": {
          "type": "string",
          "description": "The current status of the game (waiting, in_progress, finished)."
        },
        "phase": {
          "type": "string",
          "description": "The current phase of the game (night, day, voting)."
        },
        "creator": {
          "type": "string",
          "description": "Reference to the User who created the game. (Relationship: User 1:N Game)"
        },
        "players": {
          "type": "array",
          "description": "References to the Users who are participating in the game. (Relationship: User N:N Game)",
          "items": {
            "type": "string"
          }
        },
        "maxPlayers": {
          "type": "number",
          "description": "The maximum number of players allowed in the game."
        },
        "createdAt": {
          "type": "string",
          "description": "The timestamp when the game was created.",
          "format": "date-time"
        },
        "currentRound": {
          "type": "number",
          "description": "The current round number of the game."
        },
        "settings": {
          "type": "string",
          "description": "Settings for the game, such as the number of werewolves and roles."
        }
      },
      "required": [
        "id",
        "name",
        "status",
        "phase",
        "creator",
        "players",
        "maxPlayers",
        "createdAt",
        "currentRound",
        "settings"
      ]
    },
    "Player": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Player",
      "type": "object",
      "description": "Represents a player in a specific game of 'El Pueblo Duerme'.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "Reference to the User associated with this player entry. (Relationship: User 1:N Player)"
        },
        "gameId": {
          "type": "string",
          "description": "Reference to the Game this player is participating in. (Relationship: Game 1:N Player)"
        },
        "role": {
          "type": "string",
          "description": "The role assigned to the player in the game (werewolf, villager, seer, doctor, hunter)."
        },
        "isAlive": {
          "type": "boolean",
          "description": "Indicates whether the player is currently alive in the game."
        },
        "votedFor": {
          "type": "string",
          "description": "Reference to the User this player voted for. (Relationship: User 1:N Player)"
        },
        "displayName": {
          "type": "string",
          "description": "The display name of the player in the game."
        },
        "avatar": {
          "type": "string",
          "description": "URL of the player's avatar image."
        },
        "joinedAt": {
          "type": "string",
          "description": "The timestamp when the player joined the game.",
          "format": "date-time"
        }
      },
      "required": [
        "userId",
        "gameId",
        "role",
        "isAlive",
        "displayName",
        "joinedAt"
      ]
    },
    "GameLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "GameLog",
      "type": "object",
      "description": "Represents a log entry for a specific game, recording events and actions.",
      "properties": {
        "gameId": {
          "type": "string",
          "description": "Reference to the Game this log entry belongs to. (Relationship: Game 1:N GameLog)"
        },
        "type": {
          "type": "string",
          "description": "The type of event being logged (phase_change, kill, vote, ability_used)."
        },
        "message": {
          "type": "string",
          "description": "A descriptive message for the log entry."
        },
        "timestamp": {
          "type": "string",
          "description": "The timestamp when the event occurred.",
          "format": "date-time"
        },
        "data": {
          "type": "string",
          "description": "Additional data associated with the log entry (e.g., target of a kill, voter and target of a vote)."
        }
      },
      "required": [
        "gameId",
        "type",
        "message",
        "timestamp",
        "data"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "games/{gameId}",
        "definition": {
          "entityName": "Game",
          "schema": {
            "$ref": "#/backend/entities/Game"
          },
          "description": "Stores game instances. Contains general game information like status, phase, creator, and players.",
          "params": [
            {
              "name": "gameId",
              "description": "The unique identifier for the game."
            }
          ]
        }
      },
      {
        "path": "players/{playerId}",
        "definition": {
          "entityName": "Player",
          "schema": {
            "$ref": "#/backend/entities/Player"
          },
          "description": "Stores player information for each game. Documents are named `{userId}_{gameId}` to quickly retrieve player data by userId and gameId. Includes denormalized 'gameId' for authorization independence.",
          "params": [
            {
              "name": "playerId",
              "description": "The unique identifier for the player, composed of {userId}_{gameId}."
            }
          ]
        }
      },
      {
        "path": "game_logs/{gameLogId}",
        "definition": {
          "entityName": "GameLog",
          "schema": {
            "$ref": "#/backend/entities/GameLog"
          },
          "description": "Stores log entries for each game. Documents are named `{gameId}_{timestamp}` to quickly retrieve logs by gameId and timestamp. Includes denormalized 'gameId' for authorization independence.",
          "params": [
            {
              "name": "gameLogId",
              "description": "The unique identifier for the game log, composed of {gameId}_{timestamp}."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support the \"El Pueblo Duerme\" (Werewolf) game application, emphasizing security, scalability, and debuggability. It follows the core design principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), QAPs (Queries are not Filters), and Invariants. The structure uses Structural Segregation by using different collections for different entities (games, players, game_logs) and Authorization Independence via denormalization, copying relevant game data into player documents.\n\n1.  **Games Collection:** Stores general game information. The `creator` and `players` fields are used to track game ownership and participants. This structure enables efficient listing of games.\n2.  **Players Collection:** Stores individual player information within a specific game. Documents are named using a composite key `userId_gameId` for quick retrieval. The fields `userId`, `gameId`, `role`, `isAlive`, `votedFor`, `displayName`, and `joinedAt` capture the player's state.  `gameId` denormalizes the link to the game and enables secure querying of players within a specific game.\n3.  **Game Logs Collection:** Stores logs for each game, recording events like phase changes, kills, and votes. Documents are named using composite key `gameId_timestamp`.  The `gameId` denormalizes the link to the game enabling secure querying of logs for a specific game.\n\nThis design ensures Authorization Independence by avoiding `get()` calls in security rules. Each document contains enough information to validate access based on the request's authentication state (`request.auth.uid`).  The QAPs are supported by segregating data into collections with homogeneous security postures, allowing secure `list` operations. The denormalization of `gameId` into the `players` and `game_logs` collections enables secure querying of players and logs associated with a particular game without needing to perform `get()` operations on the `games` collection."
  }
}